<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>list</title>
    <style>
        td {
            padding: 5px;
        }

        button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <h2>Список товаров</h2>
    <div>
        <input type="hidden" id="productId" />
        <p>
            Имя:<br />
            <input id="productName" />
        </p>
        <p>
            category:<br />
            <input id="categoryId" type="number" />
        </p>
        <p>
            description: <br />
            <input id="description"/>
        </p>
        <p>
            price: <br />
            <input id="price" type="number"/>
        </p>
        <p>
            img: <br />
            <input id="img" />
        </p>
        <p>
            <button id="saveBtn">Сохранить</button>
            <button id="resetBtn">Сбросить</button>
        </p>
    </div>
    <table>
        <thead><tr><th>Имя</th><th>categoryId</th><th>description</th><th>price</th><th>img</th><th></th></tr></thead>
        <tbody>
        </tbody>
    </table>

    <script>
        async function getProducts() {
            const response = await fetch("/api/products", {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const products = await response.json();
                const rows = document.querySelector("tbody");
                products.forEach(product => rows.append(row(product)));
            }
        }
        async function getProduct(id) {
            const response = await fetch(`/api/products/${id}`, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const product = await response.json();
                document.getElementById("productId").value = product.productId;
                document.getElementById("productName").value = product.name;
                document.getElementById("categoryId").value = product.categoryId;
                document.getElementById("description").value = product.description;
                document.getElementById("price").value = product.price;
                document.getElementById("img").value = product.img;
            }
            else {
                const error = await response.json();
                console.log(error.message);
            }
        }
        async function createProduct(productName, productCategoryId, productDescription, productPrice, productImg) {

            const response = await fetch("/api/products", {
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    Name: productName,
                    CategoryId: parseInt(productCategoryId, 10),
                    Description: productDescription,
                    Price: parseInt(productPrice, 10),
                    Img: productImg
                })
            });
            if (response.ok === true) {
                const product = await response.json();
                document.querySelector("tbody").append(row(product));
            }
            else {
                const error = await response.json();
                console.log(error.message);
            }
        }
        async function editProduct(productId, productName, productCategoryId, productDescription, productPrice, productImg) {
            const response = await fetch("api/products", {
                method: "PUT",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    ProductId: productId,
                    Name: productName,
                    CategoryId: parseInt(productCategoryId, 10),
                    Description: productDescription,
                    Price: productPrice,
                    Img: productImg
                })
            });
            if (response.ok === true) {
                const product = await response.json();
                document.querySelector(`tr[data-rowid='${product.productId}']`).replaceWith(row(product));
            }
            else {
                const error = await response.json();
                console.log(error.message);
            }
        }
        async function deleteProduct(id) {
            const response = await fetch(`/api/products/${id}`, {
                method: "DELETE",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const product = await response.json();
                document.querySelector(`tr[data-rowid='${product.productId}']`).remove();
            }
            else {
                const error = await response.json();
                console.log(error.message);
            }
        }

        // сброс данных формы после отправки
        function reset() {
            document.getElementById("productId").value =
                document.getElementById("productName").value =
                document.getElementById("categoryId").value =
                document.getElementById("description").value =
                document.getElementById("price").value =
                document.getElementById("img").value = "";
        }
        // создание строки для таблицы
        function row(product) {

            const tr = document.createElement("tr");
            tr.setAttribute("data-rowid", product.productId);

            const nameTd = document.createElement("td");
            nameTd.append(product.name);
            tr.append(nameTd);

            const categoryTd = document.createElement("td");
            categoryTd.append(product.categoryId);
            tr.append(categoryTd);

            const descriptionTd = document.createElement("td");
            descriptionTd.append(product.description);
            tr.append(descriptionTd);

            const priceTd = document.createElement("td");
            priceTd.append(product.price);
            tr.append(priceTd);

            const imgTd = document.createElement("td");
            imgTd.append(product.img);
            tr.append(imgTd);

            const linksTd = document.createElement("td");

            const editLink = document.createElement("button");
            editLink.append("Изменить");
            editLink.addEventListener("click", async () => {
                await getProduct(product.productId);

            });
            linksTd.append(editLink);

            const removeLink = document.createElement("button");
            removeLink.append("Удалить");
            removeLink.addEventListener("click", async () => await deleteProduct(product.productId));

            linksTd.append(removeLink);
            tr.appendChild(linksTd);

            return tr;
        }
        // сброс значений формы
        document.getElementById("resetBtn").addEventListener("click", () => reset());

        // отправка формы
        document.getElementById("saveBtn").addEventListener("click", async () => {

            const id = document.getElementById("productId").value;
            const name = document.getElementById("productName").value;
            const categoryId = document.getElementById("categoryId").value;
            const description = document.getElementById("description").value;
            const price = document.getElementById("price").value;
            const img = document.getElementById("img").value;
            if (id === "")
                await createProduct(name, categoryId, description, price, img);
            else {
                await editProduct(id, name, categoryId, description, price, img);
                console.log(description);
            }
            reset();
        });

        // загрузка пользователей
        getProducts();
    </script>
</body>
</html>